import os
import time
from dotenv import load_dotenv
from langchain_openai import ChatOpenAI
from langchain_core.prompts import PromptTemplate
from langchain_core.output_parsers import StrOutputParser

# 1. –ó–ê–ì–†–£–ó–ö–ê
load_dotenv()
llm = ChatOpenAI(temperature=0.7, model="gpt-3.5-turbo") # –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ–≤—ã—à–µ –¥–ª—è –∫—Ä–µ–∞—Ç–∏–≤–∞

# --- –†–û–õ–ò (–£–ó–õ–´ –ì–†–ê–§–ê) ---

def writer_node(topic, feedback=None):
    """
     –£–∑–µ–ª –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: –ü–∏—à–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º—ã –∏ –∫—Ä–∏—Ç–∏–∫–∏.
    """
    print(f"\n‚úçÔ∏è  –ü–ò–°–ê–¢–ï–õ–¨: –†–∞–±–æ—Ç–∞—é –Ω–∞–¥ —Ç–µ–º–æ–π '{topic}'...")
    
    if feedback:
        print(f"    (–£—á–∏—Ç—ã–≤–∞—é –∫—Ä–∏—Ç–∏–∫—É: {feedback})")
        prompt_text = f"""
        –¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–≤—Ç–æ—Ä. –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ —ç—Å—Å–µ (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –Ω–∞ —Ç–µ–º—É: "{topic}".
        
        –ö–†–ò–¢–ò–ö–ê –ü–†–ï–î–´–î–£–©–ï–ô –í–ï–†–°–ò–ò: {feedback}
        
        –ò—Å–ø—Ä–∞–≤—å –æ—à–∏–±–∫–∏ –∏ —É–ª—É—á—à–∏ —Ç–µ–∫—Å—Ç —Å —É—á–µ—Ç–æ–º —ç—Ç–æ–π –∫—Ä–∏—Ç–∏–∫–∏.
        """
    else:
        prompt_text = f"""
        –¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–≤—Ç–æ—Ä. –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ —ç—Å—Å–µ (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –Ω–∞ —Ç–µ–º—É: "{topic}".
        –ü–∏—à–∏ —Å—Ä–∞–∑—É —á–∏—Å—Ç–æ–≤–∏–∫.
        """
        
    response = llm.invoke(prompt_text).content
    return response

def critic_node(draft):
    """
     –£–∑–µ–ª –∞–Ω–∞–ª–∏–∑–∞: –ò—â–µ—Ç –æ—à–∏–±–∫–∏ –∏ —Å—Ç–∞–≤–∏—Ç –æ—Ü–µ–Ω–∫—É.
    """
    print(f"\nüßê –ö–†–ò–¢–ò–ö: –ß–∏—Ç–∞—é —á–µ—Ä–Ω–æ–≤–∏–∫...")
    
    prompt_text = f"""
    –¢—ã —Å—Ç—Ä–æ–≥–∏–π —Ä–µ–¥–∞–∫—Ç–æ—Ä. –ü—Ä–æ–≤–µ—Ä—å —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç:
    
    "{draft}"
    
    –¢–≤–æ—è –∑–∞–¥–∞—á–∞:
    1. –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –æ—Ç–ª–∏—á–Ω—ã–π –∏ –æ—à–∏–±–æ–∫ –Ω–µ—Ç, –Ω–∞–ø–∏—à–∏ –æ–¥–Ω–æ —Å–ª–æ–≤–æ: –û–¢–õ–ò–ß–ù–û.
    2. –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã (—Å—Ç–∏–ª—å, –ª–æ–≥–∏–∫–∞, –≤–æ–¥–∞), –Ω–∞–ø–∏—à–∏: –ò–°–ü–†–ê–í–ò–¢–¨: [—Ç–≤–æ–∏ –∑–∞–º–µ—á–∞–Ω–∏—è].
    
    –ë—É–¥—å –∫—Ä–∞—Ç–æ–∫ –∏ —Å—Ç—Ä–æ–≥.
    """
    
    response = llm.invoke(prompt_text).content
    return response

# --- –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ (–°–∞–º–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è) ---
#  –¶–∏–∫–ª–∏—á–µ—Å–∫–∞—è –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞
def run_self_correcting_agent(topic):
    print(f"üöÄ –ó–ê–ü–£–°–ö –ò–¢–ï–†–ê–¢–ò–í–ù–û–ì–û –ê–ì–ï–ù–¢–ê (–¢–µ–º–∞: {topic})\n" + "="*50)
    
    current_draft = ""
    feedback = None
    iteration = 0
    max_iterations = 4 # –ó–∞—â–∏—Ç–∞ –æ—Ç –≤–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
    
    while iteration < max_iterations:
        iteration += 1
        print(f"\n--- –ò–¢–ï–†–ê–¶–ò–Ø {iteration} ---")
        
        # 1. –ü–ò–°–ê–¢–ï–õ–¨ –ü–ò–®–ï–¢
        current_draft = writer_node(topic, feedback)
        print(f"üìù –ß–ï–†–ù–û–í–ò–ö:\n{current_draft}")
        
        # 2. –ö–†–ò–¢–ò–ö –ü–†–û–í–ï–†–Ø–ï–¢
        critique = critic_node(current_draft)
        print(f"üì¢ –í–ï–†–î–ò–ö–¢: {critique}")
        
        # 3. –ü–†–û–í–ï–†–ö–ê –£–°–õ–û–í–ò–Ø (Conditional Logic)
        if "–û–¢–õ–ò–ß–ù–û" in critique.upper():
            print(f"\n‚úÖ –ö–∞—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ! –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É.")
            break
        elif "–ò–°–ü–†–ê–í–ò–¢–¨" in critique.upper():
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–∞–º—É —Å—É—Ç—å –∫—Ä–∏—Ç–∏–∫–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫—Ä—É–≥–∞
            feedback = critique.replace("–ò–°–ü–†–ê–í–ò–¢–¨:", "").strip()
            print(f"üîÑ –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É...")
            time.sleep(1) # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞
        else:
            # –ï—Å–ª–∏ –∫—Ä–∏—Ç–∏–∫ –≤—ã–¥–∞–ª —á—Ç–æ-—Ç–æ —Å—Ç—Ä–∞–Ω–Ω–æ–µ
            print("‚ö†Ô∏è –ö—Ä–∏—Ç–∏–∫ –¥–∞–ª –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç. –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ.")
            break
            
    # [cite: 89-90] –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    print("="*50)
    print(f"\nüèÜ –§–ò–ù–ê–õ–¨–ù–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢:\n{current_draft}")

# --- –ó–ê–ü–£–°–ö ---
if __name__ == "__main__":
    # –ó–∞–¥–∞–¥–∏–º —Å–ª–æ–∂–Ω—É—é —Ç–µ–º—É, —á—Ç–æ–±—ã –±—ã–ª–æ —á—Ç–æ –∫—Ä–∏—Ç–∏–∫–æ–≤–∞—Ç—å
    # –ù–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ø—Ä–æ—Å–∏–º –Ω–∞–ø–∏—Å–∞—Ç—å —Ñ–∞–∫—Ç, –Ω–æ –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ –Ω–µ –¥–∞–¥–∏–º –¥–µ—Ç–∞–ª–µ–π,
    # —á—Ç–æ–±—ã –ö—Ä–∏—Ç–∏–∫ –º–æ–≥ –ø—Ä–∏–¥—Ä–∞—Ç—å—Å—è –∫ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—é –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏.
    topic = "–ü–æ—á–µ–º—É –Ω–µ–±–æ –≥–æ–ª—É–±–æ–µ? –û–±—ä—è—Å–Ω–∏ –¥–ª—è —Ä–µ–±–µ–Ω–∫–∞ 5 –ª–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É—è –Ω–∞—É—á–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã."
    
    run_self_correcting_agent(topic)